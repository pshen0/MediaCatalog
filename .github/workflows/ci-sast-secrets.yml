name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"
      - ".github/workflows/ci-sast-secrets.yml"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast_secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Полная история для Gitleaks

      - name: Ensure evidence dirs
        run: mkdir -p EVIDENCE/P10

      - name: Semgrep CI (SARIF)
        run: |
          # Используем фиксированную версию для воспроизводимости
          docker run --rm -v $PWD:/src returntocorp/semgrep:v1.45.0 \
            semgrep ci \
              --config p/ci \
              --config /src/security/semgrep/rules.yml \
              --sarif \
              --output /src/EVIDENCE/P10/semgrep.sarif \
              --metrics=off \
              --disable-version-check || true

          # Проверяем наличие отчёта
          if [ ! -f EVIDENCE/P10/semgrep.sarif ]; then
            echo "Warning: Semgrep SARIF report was not created"
            # Создаём пустой SARIF для совместимости
            echo '{"version": "2.1.0", "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema.json", "runs": [{"tool": {"driver": {"name": "Semgrep"}}, "results": []}]}' > EVIDENCE/P10/semgrep.sarif
          fi

          echo "Semgrep scan completed"

      - name: Gitleaks detect
        run: |
          # Используем фиксированную версию для воспроизводимости
          docker run --rm -v $PWD:/repo zricethezav/gitleaks:v8.18.0 \
            detect \
              --no-banner \
              --config=/repo/security/.gitleaks.toml \
              --source=/repo \
              --report-format=json \
              --report-path=/repo/EVIDENCE/P10/gitleaks.json \
              --verbose || true

          # Проверяем наличие отчёта
          if [ ! -f EVIDENCE/P10/gitleaks.json ]; then
            echo "Warning: Gitleaks report was not created"
            # Создаём пустой JSON для совместимости
            echo '[]' > EVIDENCE/P10/gitleaks.json
          fi

          echo "Gitleaks scan completed"

      - name: Generate SAST Summary
        run: |
          set -e

          # Проверяем наличие jq
          if ! command -v jq &> /dev/null; then
            echo "Error: jq is not installed"
            exit 1
          fi

          # Создаём summary
          cat > EVIDENCE/P10/sast_summary.md << 'EOF'
          # SAST & Secrets Scanning Summary

          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}
          Workflow Run: ${{ github.run_id }}
          Job URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Semgrep Findings

          EOF

          # Извлекаем статистику из SARIF
          if [ -f EVIDENCE/P10/semgrep.sarif ]; then
            TOTAL_RESULTS=$(jq -r '[.runs[].results[]] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
            echo "Total Semgrep findings: $TOTAL_RESULTS" >> EVIDENCE/P10/sast_summary.md

            # Группируем по severity
            echo "" >> EVIDENCE/P10/sast_summary.md
            echo "### Findings by Severity" >> EVIDENCE/P10/sast_summary.md
            echo "" >> EVIDENCE/P10/sast_summary.md

            ERROR_COUNT=$(jq -r '[.runs[].results[] | select(.level == "error")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
            WARNING_COUNT=$(jq -r '[.runs[].results[] | select(.level == "warning")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
            INFO_COUNT=$(jq -r '[.runs[].results[] | select(.level == "info")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")

            echo "- **Error**: $ERROR_COUNT" >> EVIDENCE/P10/sast_summary.md
            echo "- **Warning**: $WARNING_COUNT" >> EVIDENCE/P10/sast_summary.md
            echo "- **Info**: $INFO_COUNT" >> EVIDENCE/P10/sast_summary.md

            # Топ-5 findings
            if [ "$TOTAL_RESULTS" -gt 0 ]; then
              echo "" >> EVIDENCE/P10/sast_summary.md
              echo "### Top Findings" >> EVIDENCE/P10/sast_summary.md
              echo "" >> EVIDENCE/P10/sast_summary.md
              jq -r '.runs[].results[0:5] | .[] | "- **\(.ruleId)**: \(.message.text) (severity: \(.level))"' \
                EVIDENCE/P10/semgrep.sarif 2>/dev/null | head -5 >> EVIDENCE/P10/sast_summary.md || echo "Unable to extract findings details" >> EVIDENCE/P10/sast_summary.md
            fi
          else
            echo "Semgrep report not available" >> EVIDENCE/P10/sast_summary.md
          fi

          # Добавляем секцию Gitleaks
          cat >> EVIDENCE/P10/sast_summary.md << 'EOF'

          ## Gitleaks Findings

          EOF

          if [ -f EVIDENCE/P10/gitleaks.json ]; then
            SECRETS_COUNT=$(jq '. | length' EVIDENCE/P10/gitleaks.json 2>/dev/null || echo "0")
            echo "Total potential secrets found: $SECRETS_COUNT" >> EVIDENCE/P10/sast_summary.md

            if [ "$SECRETS_COUNT" -gt 0 ]; then
              echo "" >> EVIDENCE/P10/sast_summary.md
              echo "### Detected Secrets" >> EVIDENCE/P10/sast_summary.md
              echo "" >> EVIDENCE/P10/sast_summary.md
              jq -r '.[0:5] | .[] | "- **\(.RuleID)**: \(.File) (line \(.StartLine))"' \
                EVIDENCE/P10/gitleaks.json 2>/dev/null | head -5 >> EVIDENCE/P10/sast_summary.md || echo "Unable to extract secrets details" >> EVIDENCE/P10/sast_summary.md
            else
              echo "✅ No secrets detected" >> EVIDENCE/P10/sast_summary.md
            fi
          else
            echo "Gitleaks report not available" >> EVIDENCE/P10/sast_summary.md
          fi

          # Добавляем секцию с планом действий
          cat >> EVIDENCE/P10/sast_summary.md << 'EOF'

          ## Next Steps

          1. Review full reports:
             - `semgrep.sarif` - Full Semgrep results (SARIF format)
             - `gitleaks.json` - Full Gitleaks results (JSON format)

          2. For Semgrep findings:
             - Fix high/critical severity issues immediately
             - Review and address warnings based on project context
             - Update `security/semgrep/rules.yml` if false positives are identified

          3. For Gitleaks findings:
             - Verify if detected secrets are real or false positives
             - If real: rotate secrets immediately and remove from git history
             - If false positive: add to allowlist in `security/.gitleaks.toml`

          4. Track remediation:
             - Create Issues for findings that require follow-up
             - Update code/configuration based on findings
             - Document decisions in PR descriptions

          ## Evidence Files

          - `semgrep.sarif` - Semgrep SAST results (SARIF 2.1.0 format)
          - `gitleaks.json` - Gitleaks secrets detection results (JSON format)
          - `sast_summary.md` - This summary document

          See `EVIDENCE/P10/README.md` for more information about the evidence structure.
          EOF

          # Заменяем переменные
          sed -i "s/\$(date -u +\"%Y-%m-%d %H:%M:%S UTC\")/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/g" EVIDENCE/P10/sast_summary.md

          echo "SAST summary generated"
          cat EVIDENCE/P10/sast_summary.md

      - name: Upload SAST & Secrets evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: P10_EVIDENCE
          path: EVIDENCE/P10
          retention-days: 90
