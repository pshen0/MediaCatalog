name: Security - SBOM & SCA

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "requirements*.txt"
      - ".github/workflows/ci-sbom-sca.yml"
      - "policy/waivers.yml"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sbom_sca:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure evidence dirs
        run: mkdir -p EVIDENCE/P09

      - name: Generate SBOM (Syft CycloneDX)
        run: |
          # Используем фиксированную версию Syft для воспроизводимости
          docker run --rm -v $PWD:/work -w /work anchore/syft:v1.5.0 \
            packages dir:. -o cyclonedx-json > EVIDENCE/P09/sbom.json

          # Проверяем, что SBOM создан
          if [ ! -f EVIDENCE/P09/sbom.json ]; then
            echo "Error: SBOM generation failed"
            exit 1
          fi

          echo "SBOM generated successfully"
          echo "SBOM size: $(wc -c < EVIDENCE/P09/sbom.json) bytes"

      - name: SCA Scan (Grype)
        run: |
          set -e

          # Используем фиксированную версию Grype для воспроизводимости
          docker run --rm -v $PWD:/work -w /work anchore/grype:v0.78.0 \
            sbom:/work/EVIDENCE/P09/sbom.json -o json > EVIDENCE/P09/sca_report.json || {
            echo "Warning: Grype scan completed with non-zero exit code, but report may still be valid"
          }

          # Проверяем наличие отчёта и что это валидный JSON
          if [ ! -f EVIDENCE/P09/sca_report.json ]; then
            echo "Error: SCA report file was not created"
            exit 1
          fi

          # Проверяем, что это валидный JSON
          if ! jq empty EVIDENCE/P09/sca_report.json 2>/dev/null; then
            echo "Error: SCA report is not valid JSON"
            exit 1
          fi

          echo "SCA scan completed successfully"

      - name: Generate SCA Summary
        run: |
          set -e

          # Проверяем наличие jq (обычно установлен в ubuntu-latest)
          if ! command -v jq &> /dev/null; then
            echo "Error: jq is not installed"
            exit 1
          fi

          # Создаём детальный summary с агрегацией по severity
          cat > EVIDENCE/P09/sca_summary.md << 'EOF'
          # SCA Vulnerability Summary

          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}
          Workflow Run: ${{ github.run_id }}
          Job URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Severity Distribution

          EOF

          # Агрегируем по severity (обрабатываем случай, когда matches отсутствует или пуст)
          if jq -e '.matches | length > 0' EVIDENCE/P09/sca_report.json > /dev/null 2>&1; then
            jq -r '[.matches[].vulnerability.severity] | group_by(.) | map({severity: .[0], count: length}) | .[] | "\(.severity): \(.count)"' \
              EVIDENCE/P09/sca_report.json | sort -r >> EVIDENCE/P09/sca_summary.md
          else
            echo "No vulnerabilities found" >> EVIDENCE/P09/sca_summary.md
          fi

          # Добавляем секцию с критическими и высокими уязвимостями
          cat >> EVIDENCE/P09/sca_summary.md << 'EOF'

          ## Critical & High Severity Vulnerabilities

          EOF

          # Извлекаем Critical и High уязвимости
          if jq -e '.matches[] | select(.vulnerability.severity == "Critical" or .vulnerability.severity == "High")' \
            EVIDENCE/P09/sca_report.json > /dev/null 2>&1; then
            jq -r '.matches[] | select(.vulnerability.severity == "Critical" or .vulnerability.severity == "High") |
              "- **\(.vulnerability.id)** (\(.vulnerability.severity)): \(.artifact.name)@\(.artifact.version) - \(.vulnerability.description // "No description")"' \
              EVIDENCE/P09/sca_report.json | head -20 >> EVIDENCE/P09/sca_summary.md
          else
            echo "No Critical or High severity vulnerabilities found" >> EVIDENCE/P09/sca_summary.md
          fi

          # Добавляем общую статистику
          cat >> EVIDENCE/P09/sca_summary.md << 'EOF'

          ## Total Vulnerabilities

          EOF

          TOTAL=$(jq -r '.matches | length // 0' EVIDENCE/P09/sca_report.json 2>/dev/null || echo "0")
          echo "Total vulnerabilities found: $TOTAL" >> EVIDENCE/P09/sca_summary.md

          # Добавляем информацию о пакетах
          cat >> EVIDENCE/P09/sca_summary.md << 'EOF'

          ## Affected Packages Summary

          EOF

          if jq -e '.matches | length > 0' EVIDENCE/P09/sca_report.json > /dev/null 2>&1; then
            jq -r '[.matches[] | .artifact.name] | unique | .[]' \
              EVIDENCE/P09/sca_report.json | sort | head -20 | sed 's/^/- /' >> EVIDENCE/P09/sca_summary.md
          else
            echo "No affected packages" >> EVIDENCE/P09/sca_summary.md
          fi

          # Добавляем ссылку на полный отчёт
          cat >> EVIDENCE/P09/sca_summary.md << 'EOF'

          ## Next Steps

          1. Review the full report: `EVIDENCE/P09/sca_report.json`
          2. Check `policy/waivers.yml` for existing waivers
          3. For Critical/High vulnerabilities:
             - Update dependencies to patched versions if available
             - Create waivers with justification if fixes are not available
             - Track remediation in issues/PRs

          ## Evidence Files

          - `sbom.json` - Software Bill of Materials (CycloneDX format)
          - `sca_report.json` - Full SCA scan results (Grype JSON format)
          - `sca_summary.md` - This summary document

          See `EVIDENCE/P09/README.md` for more information about the evidence structure.
          EOF

          # Заменяем переменные в summary
          sed -i "s/\$(date -u +\"%Y-%m-%d %H:%M:%S UTC\")/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/g" EVIDENCE/P09/sca_summary.md

          echo "SCA summary generated"
          cat EVIDENCE/P09/sca_summary.md

      - name: Upload SBOM/SCA evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: P09_EVIDENCE
          path: EVIDENCE/P09
          retention-days: 90
