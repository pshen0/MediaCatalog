# ADR-002: Secure Content Update API
Дата: 2025-09-22
Статус: Accepted

## Context

Сервис Media Catalog хранит записи о том, что пользователь смотрит, что запланировал, что уже просмотрено.
Проблема: клиент может прислать некорректные данные (например, чужой user_id, неверный content_id, манипуляции с датами или статусами). Это потенциально позволяет:
- подменять чужие записи
- ломать сервис
- создавать неконсистентные данные

Нужно безопасно обновлять и добавлять записи, валидируя все входные данные и блокируя любые попытки манипуляций.

### Alternatives

| Альтернатива | Плюсы | Минусы |
| ------------ | ----- | ------ |
| Включить только проверку `user_id` | Просто реализовать | Не защищает от некорректных статусов и даты |
| Полная валидация через DB constraints | Жёсткая защита на уровне БД | Сложно поддерживать, медленнее при обновлении нескольких записей |
| Middleware + Pydantic + UUID | Баланс: быстро, проверяемо, интегрировано | Нужно писать дополнительные тесты и логирование |

Выбран последний вариант: Middleware + Pydantic + UUID, потому что он применим к текущему стеку (FastAPI + in-memory DB).

## Decision
1. Решено внедрить Secure Content Update API с такими мерами:

- Валидация входа (Pydantic)
- user_id обязателен и совпадает с текущим пользователем
- content_id должен существовать в базе контента
- status ограничен перечислением
- timestamp в формате ISO 8601, не в будущем

2. UUID для записи

Каждая запись получает уникальный record_id, чтобы нельзя было угадать чужую запись

3. Проверка прав доступа

CRUD операций по user_id — только для владельца

4. Тесты безопасности

- отказ на запросы с чужим user_id
- отказ на запросы с некорректными статусами
- отказ на записи с будущей датой
- Проверка формата ошибок через RFC7807 (correlation_id)

5. Контроль и метрики

- Логирование всех изменений
- Rate limit на /update_record: 60 req/min

## Rollout Plan / Definition of Done

### Rollout Plan

1. Feature flag

- Включить SECURE_UPDATE_ENABLED для возможности постепенного запуска.

2. Тестовое окружение

- Деплой на staging с включённой валидацией Pydantic и логированием.
- Проверка корректности всех негативных кейсов (чужой user_id, некорректный статус, future timestamp).

3. Мониторинг и rate limit
- Rate limit на /update_record: 60 req/min.
- Логи с correlation_id для всех изменений.

4. CI / автоматические тесты

- Все unit и security-тесты проходят (pytest -q).
- RFC7807 формат ошибок проверен.

### Definition of Done (DoD):

- Реализован API /update_record с Pydantic-валидацией.
- CRUD ограничен владельцем (user_id).
- Все тесты (негативные и граничные) проходят.
- Логирование с correlation_id включено.
- Rate limiting работает.
- RFC7807 ошибки возвращаются для некорректных запросов.
- CI зелёный, feature flag работает корректно.

## Consequences
Положительные эффекты:

- Исключает подмену чужих записей (R5, R6)
- Валидирует все поля (status, timestamp)
- RFC7807 ошибки позволяют трассировать инциденты по correlation_id

Негативные эффекты:

- Добавляются тесты и логирование

Связь с Threat Model / NFR:
- NFR-03, NFR-08;
- R5, F5, R6, SVC;

## Links
- NFR-03, NFR-08;
- R5, F5, R6, SVC;
- tests/<файл>::<тест>
