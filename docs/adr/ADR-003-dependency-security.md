# ADR-003: Dependency & Secrets Security
Дата: 2025-09-22
Статус: Accepted

## Context

Media Catalog хранит чувствительные данные пользователей: что они смотрят, запланировали или уже посмотрели.
Проблемы:
- Потенциальная утечка секретов через git-историю или логирование
- Использование уязвимых зависимостей может скомпрометировать сервис (R9)

Нужно гарантировать, что:
- Секреты не хранятся в коде
- Зависимости проверяются на уязвимости
- Процесс CI фиксирует нарушения

### Alternatives

| Альтернатива | Плюсы | Минусы |
| ------------ | ----- | ------ |
| Хранить секреты в коде + .gitignore | Просто, быстро | Высокий риск утечки (R10), нарушает NFR-06 |
| Проверка зависимостей только локально | Минимальная нагрузка | Не гарантирует безопасность для всего CI/Team |
| Pre-commit + CI scans + env vars | Полная проверка, интегрируется с стеком FastAPI + GitHub Actions | Требует настройки CI и pre-commit |

Выбран последний вариант, т.к. он реально закрывает угрозы из P04 и требования NFR-04/06.

## Decision
1. CI Security Scans

- Используем pip-audit и safety для проверки уязвимостей зависимостей
- Ошибки с высоким CVSS блокируют CI

2. Pre-commit hooks

- detect-secrets для проверки коммитов на наличие токенов/ключей
- Скрипт запускается при каждом коммите, запрещает утечку секретов

3. Секреты через окружение

- Все ключи, токены и пароли читаются только через os.getenv()

4. Мониторинг

- CI уведомляет о новых уязвимостях

## Rollout Plan / Definition of Done

### Rollout Plan

1. Pre-commit настроен и блокирует коммиты с секретами
2. Тесты: tests/test_env_vars.py проверяют, что секреты читаются только через os.getenv()
3. CI workflow (.github/workflows/ci.yml) зелёный, включает pip-audit и safety

### Definition of Done (DoD):

- CI проходит
- Pre-commit блокирует секреты
- Уязвимости зависимостей выявлены и исправлены
- Тесты tests/test_env_vars.py зелёные

## Consequences
Положительные эффекты:

- Секреты не попадают в git или логи
- Уязвимые зависимости блокируются на этапе CI
- Соответствие NFR-04  и NFR-06

Негативные эффекты:
- CI может падать при новых уязвимостях — требует фикса/обновления зависимостей
- Необходимо поддерживать pre-commit

Связь с Threat Model / NFR:
- NFR-04, NFR-04, NFR-6;
- R1, R9, R10, CI/CD, Repo;;

## Links
- NFR-04, NFR-04, NFR-6;
- R1, R9, R10, CI/CD, Repo;
- tests/<файл>::<тест>
