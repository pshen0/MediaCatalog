rules:
  # Правила для FastAPI и безопасности веб-приложений

  - id: fastapi-unsafe-user-input
    languages: [python]
    message: "Потенциально небезопасное использование пользовательского ввода без валидации"
    severity: WARNING
    patterns:
      - pattern-either:
          - pattern: |
              $RESPONSE($USER_INPUT)
          - pattern: |
              $DB.query($USER_INPUT)
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      owasp: "A03:2021 – Injection"

  - id: fastapi-missing-auth-check
    languages: [python]
    message: "Эндпоинт может не проверять авторизацию пользователя"
    severity: ERROR
    patterns:
      - pattern-not-inside: |
          @router.$METHOD(...)
          def $FUNC(..., user=Depends($AUTH), ...):
            ...
      - pattern: |
          @router.$METHOD(...)
          def $FUNC(...):
            ...
    metadata:
      category: security
      cwe: "CWE-306: Missing Authentication for Critical Function"
      owasp: "A01:2021 – Broken Access Control"

  - id: fastapi-owner-check-missing
    languages: [python]
    message: "Проверка владельца ресурса может отсутствовать перед модификацией"
    severity: WARNING
    patterns:
      - pattern-not-inside: |
          if $OBJ["owner_id"] != $USER["id"]:
            ...
      - pattern: |
          $OBJ.update(...)
          $OBJ[...] = ...
          del $OBJ[...]
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      owasp: "A01:2021 – Broken Access Control"

  - id: python-hardcoded-secrets
    languages: [python]
    message: "Обнаружена потенциально захардкоженная секретная информация"
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: |
              $VAR = "sk-..."
          - pattern: |
              $VAR = "AKIA..."
          - pattern: |
              $VAR = "ghp_..."
          - pattern: |
              password = "..."
          - pattern: |
              api_key = "..."
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"
      owasp: "A07:2021 – Identification and Authentication Failures"

  - id: python-unsafe-eval
    languages: [python]
    message: "Использование eval() может быть небезопасным"
    severity: ERROR
    patterns:
      - pattern: eval(...)
      - pattern: exec(...)
    metadata:
      category: security
      cwe: "CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code"
      owasp: "A03:2021 – Injection"

  - id: python-sql-injection-risk
    languages: [python]
    message: "Потенциальный риск SQL-инъекции при использовании строковой конкатенации в запросах"
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: |
              $QUERY = "SELECT ... " + $VAR + " ..."
          - pattern: |
              $QUERY = f"SELECT ... {${VAR}} ..."
          - pattern: |
              $QUERY = "SELECT ... %s ..." % $VAR
    metadata:
      category: security
      cwe: "CWE-89: Improper Neutralization of Special Elements used in an SQL Command"
      owasp: "A03:2021 – Injection"

  - id: fastapi-cors-misconfiguration
    languages: [python]
    message: "CORS может быть настроен слишком широко (allow_origins=['*'])"
    severity: WARNING
    patterns:
      - pattern: |
          CORSMiddleware(..., allow_origins=["*"], ...)
    metadata:
      category: security
      cwe: "CWE-942: Permissive Cross-domain Policy with Untrusted Domains"
      owasp: "A05:2021 – Security Misconfiguration"

  - id: python-weak-random
    languages: [python]
    message: "Использование слабого генератора случайных чисел для криптографических целей"
    severity: WARNING
    patterns:
      - pattern-either:
          - pattern: |
              random.$METHOD(...)
          - pattern: |
              import random
              ...
              random.$METHOD(...)
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      owasp: "A02:2021 – Cryptographic Failures"
